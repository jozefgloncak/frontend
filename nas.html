<script>

    const NASOBOK = "nasobok";
    const NASOBENIE_S = "nasobenieS";
    const ALL = "Vsetko";
    var skipList = new Set([0, 1, 2, 10]);
    var pool = [];
    var amount = 0
    var generatedCouples = 0
    var currentCouple
    var totalIncorrect = 0

    /**
     * List of couples from which are generated examples.
     */
    function generateProblemsPool() {
        this.pool = [];
        for (let i = 0; i <= 10; i++) {
            for (let j = 0; j <= 10; j++) {
                if (document.getElementById(NASOBOK+i).checked &&
                    document.getElementById(NASOBENIE_S+j).checked) {
                    this.pool.push([i, j]);
                }
            }
        }
    }

    function generate() {
        this.currentCouple = null;
        this.generatedCouples = 0
        document.getElementById("finalResult").textContent = ""
        this.totalIncorrect = 0
        generateProblemsPool();
        //disable input for number of examples
        amount = parseInt(document.getElementById("amount").value);
        let amountEl = document.getElementById("amount");
        amountEl.disabled = true;
        amountEl.style.background = "lightgrey";

        document.getElementById("problems").style.visibility = "visible";
        document.getElementById("problem").textContent = "";
        document.getElementById("evaluation").textContent = "";
        setFocus("result")
    }

    function selectCouple() {
        let idxProblem = Math.floor(Math.random() * this.pool.length);
        if (generatedCouples != amount && this.pool.length != 0) {
            this.currentCouple = this.pool[idxProblem]
            document.getElementById("problem").textContent = this.currentCouple[0] + " . " + this.currentCouple[1];
            this.pool.splice(idxProblem, 1);

            document.getElementById("result").value = "";
            generatedCouples++
        } else {
            document.getElementById("problems").style.visibility = "hidden";
            document.getElementById("amount").style.background = "white";
            document.getElementById("amount").disabled = false;
            let totalCorrect = amount - totalIncorrect
            document.getElementById("finalResult").textContent = "Správne: " + totalCorrect + "/" + amount;
        }
    }

    function validateResult() {
        if (currentCouple) {
            response = document.getElementById("result").value
            let correctResponse = currentCouple[0] * currentCouple[1]
            addToEvaluation(currentCouple, response, correctResponse)
        }
    }

    function addToEvaluation(currentCouple, response, correctResponse) {
        let divEl = document.createElement("div");
        divEl.textContent = this.currentCouple[0] + " . " + this.currentCouple[1] + " = " + response;
        divEl.style.color = "green";
        if (response != correctResponse) {
            this.totalIncorrect++;
            divEl.textContent += "(" + correctResponse + ")";
            divEl.style.color = "red";
        }
        let evalEl = document.getElementById("evaluation");
        evalEl.appendChild(divEl);
    }

    function handleEnter(ev) {
        if (ev.key === "Enter") {
            validateResult()
            selectCouple()
        }
    }

    function afterLoad() {
        setFocus('start');
        //generate radio buttons for nasobky
        nasobkyEl = document.getElementById("nasobky");
        for (let i = 0; i <= 10; i++) {
            generateRadioButton(nasobkyEl, i, NASOBOK, !this.skipList.has(i))
        }
        let riElNasobky = generateRadioButton(nasobkyEl, ALL, NASOBOK, false)
        nasobenieSEl = document.getElementById("nasobenieS");
        for (let i = 0; i <= 10; i++) {
            generateRadioButton(nasobenieSEl, i, NASOBENIE_S, !this.skipList.has(i))
        }
        let riElNasobkyS = generateRadioButton(nasobenieSEl, ALL, NASOBENIE_S, false)

        riElNasobkyS.addEventListener("click", (ev) => {
            for (let i = 0; i <= 10; i++) {
                document.getElementById(NASOBENIE_S + i).checked = ev.target.checked
            }
        })

        riElNasobky.addEventListener("click", (ev) => {
            for (let i = 0; i <= 10; i++) {
                document.getElementById(NASOBOK + i).checked = ev.target.checked
            }
        })
    }

    function generateRadioButton(parent, idSuffix, id, check) {
        let divEl = document.createElement("div");
        parent.appendChild(divEl);
        let riLableEl = document.createElement("label")
        riLableEl.for = id + idSuffix;
        riLableEl.textContent = idSuffix
        divEl.appendChild(riLableEl);
        let riEl = document.createElement("input");
        riEl.type = "checkbox";
        riEl.id = id + idSuffix;
        riEl.checked = check;
        divEl.appendChild(riEl);
        return riEl;
    }

    function setFocus(elId) {
        let startButton = document.getElementById(elId)
        startButton.focus({focusVisible: true})
    }
</script>
<style>
    /*label {*/
    /*    display: block;*/
    /*}*/

    span {
        /*font-size: 50px;*/
    }
</style>
<body onload="afterLoad()">
    <label for="amount" value="">Počet príkladov:</label>
    <input type="input" id="amount" value="20"/>
    <br/>
    Násobky čísla:
    <div id="nasobky" style="display:flex; justify-content: space-around; width:600px"></div>
    <br />
    Vynechaj násobenie s:
    <div id="nasobenieS" style="display:flex; justify-content: space-around; width:600px"></div>

    <br />
    <br/>

    <input type="button" id="start" value="Generovať" onclick="generate(event)"/>
    <div id="container" style="display:flex; justify-content: space-around">
        <div id="problems" style="visibility:hidden">
            <span id="problem"></span>
            <span>=</span>
            <input id="result" maxlength="2" style="width: 25px" onkeyup="handleEnter(event)"></input>
        </div>
        <div id="evaluation">
        </div>
    </div>
    <span id="finalResult"></span>
</body>
