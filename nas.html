<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<script>

    const NASOBOK = "nasobok";
    const NASOBENIE_S = "nasobenieS";
    const NASOBENIE_S_VSETKO = "nasobenieSVsetko";
    const ALL = "Vsetko";
    const EL_NASOBKY = "nasobky";
    const EL_NASOBOK_VSETKO = "nasobokVsetko";
    const EL_RESULT = "result";
    const EL_GENEROVAT_BTN = "generate"
    var skipList = new Set([0, 1, 2, 10]);
    var pool = [];
    var amount = 0
    var generatedCouples = 0
    var currentCouple
    var totalIncorrect = 0

    /**
     * List of couples from which are generated examples.
     */
    function generateProblemsPool() {
        this.pool = [];
        for (let i = 0; i <= 10; i++) {
            for (let j = 0; j <= 10; j++) {
                if (document.getElementById(NASOBOK+i).checked &&
                    document.getElementById(NASOBENIE_S+j).checked) {
                    this.pool.push([i, j]);
                }
            }
        }
    }

    function generate() {
        this.currentCouple = null;
        this.generatedCouples = 0
        document.getElementById("finalResult").textContent = ""
        this.totalIncorrect = 0
        generateProblemsPool();
        //disable input for number of examples
        amount = parseInt(document.getElementById("amount").value);
        let amountEl = document.getElementById("amount");
        amountEl.disabled = true;
        amountEl.style.background = "lightgrey";

        document.getElementById("problems").style.visibility = "visible";
        document.getElementById("problem").textContent = "";
        document.getElementById("evaluation").textContent = "";
        selectCouple();
        setFocus("result")
    }

    function selectCouple() {
        let idxProblem = Math.floor(Math.random() * this.pool.length);
        if (generatedCouples != amount && this.pool.length != 0) {
            this.currentCouple = this.pool[idxProblem]
            document.getElementById("problem").textContent = this.currentCouple[0] + " . " + this.currentCouple[1] +
                " = ";
            this.pool.splice(idxProblem, 1);

            document.getElementById("result").value = "";
            generatedCouples++
        } else {
            document.getElementById("problems").style.visibility = "hidden";
            document.getElementById("amount").style.background = "white";
            document.getElementById("amount").disabled = false;
            let totalCorrect = amount - totalIncorrect
            document.getElementById("finalResult").textContent = "Správne: " + totalCorrect + "/" + amount;
        }
    }

    function validateResult() {
        if (currentCouple) {
            response = document.getElementById("result").value
            let correctResponse = currentCouple[0] * currentCouple[1]
            addToEvaluation(currentCouple, response, correctResponse)
        }
    }

    function addToEvaluation(currentCouple, response, correctResponse) {
        let divEl = document.createElement("div");
        divEl.textContent = this.currentCouple[0] + " . " + this.currentCouple[1] + " = " + response;
        divEl.style.color = "green";
        if (response != correctResponse) {
            this.totalIncorrect++;
            divEl.textContent += "(" + correctResponse + ")";
            divEl.style.color = "red";
        }
        let evalEl = document.getElementById("evaluation");
        evalEl.prepend(divEl);
    }

    function setCheckboxesChecked(ev, elPrefix) {
        for (let i = 0; i <= 10; i++) {
            document.getElementById(elPrefix + i).checked = ev.target.checked
        }
    }

    function afterLoad() {
        setFocus(EL_GENEROVAT_BTN);
        //generate radio buttons for nasobky
        nasobokEl = document.getElementById(NASOBOK);
        for (let i = 0; i <= 10; i++) {
            generateRadioButton(nasobokEl, i, NASOBOK, !this.skipList.has(i))
        }

        nasobenieSEl = document.getElementById(NASOBENIE_S);
        for (let i = 0; i <= 10; i++) {
            generateRadioButton(nasobenieSEl, i, NASOBENIE_S, !this.skipList.has(i))
        }

        nasobenieSVsetkoEl = document.getElementById(NASOBENIE_S_VSETKO);
        nasobenieSVsetkoEl.addEventListener("click", ev => {setCheckboxesChecked(ev, NASOBENIE_S)})

        riElNasobokVsetko = document.getElementById(EL_NASOBOK_VSETKO)
        riElNasobokVsetko.addEventListener("click", ev => {setCheckboxesChecked(ev, NASOBOK)})

        //handler for enter on result input element
        resultEl = document.getElementById(EL_RESULT);
        resultEl.addEventListener("keyup", ev => {
            if (ev.key === "Enter") {
                validateResult()
                selectCouple()
            }
        });

        //handler for generovat button
        generateButtonEl = document.getElementById(EL_GENEROVAT_BTN);
        generateButtonEl.addEventListener("click", ev => {generate(ev)});

    }

    /**
     * Create radio button with label wrapped inside div.
     *
     * Example: <div>
     *            <label for={id+idSuffix} class="text">{isDuffix}</label>
     *            <input type="checkbox" id="{id+idSuffix} checked={checked} />
     *          </div>
     * @param parent
     * @param idSuffix
     * @param id
     * @param check
     * @returns {HTMLInputElement}
     */
    function generateRadioButton(parent, idSuffix, id, check) {
        let divEl = document.createElement("div");
        divEl.className = "w3-right-align w3-col s6 m2"
        parent.appendChild(divEl);
        let riLableEl = document.createElement("label")
        riLableEl.for = id + idSuffix;
        riLableEl.textContent = idSuffix;
        riLableEl.className = "text"
        divEl.appendChild(riLableEl);
        let riEl = document.createElement("input");
        riEl.type = "checkbox";
        riEl.id = id + idSuffix;
        riEl.checked = check;
        divEl.appendChild(riEl);
        return riEl;
    }

    function setFocus(elId) {
        let el = document.getElementById(elId)
        el.focus({focusVisible: true})
    }
</script>
<style>

    input[type="checkbox"] {
        width: 50px;
        height: 50px;
    }
    .text {
        font-size: 40px;
    }

    .mainText {
        font-size: 60px;
    }
</style>
<body onload="afterLoad()">
    <div class="w3-row" style="max-width:900px">
        <label for="amount" value="">Počet príkladov:</label>
        <input type="input" id="amount" value="20" class="text" style="width:100px"/>
        <br />
        Násobky čísla:
        <div class="w3-right-align w3-margin">
            <label class="text">Všetky</label>
            <input type="checkbox" id="nasobokVsetko">
        </div>
        <div id="nasobok" class="w3-row w3-margin"></div>
        <br />
        Vynechaj násobenie s:
        
        <div class="w3-right-align w3-margin">
            <label class="text">Všetky</label>
            <input type="checkbox" id="nasobenieSVsetko">
        </div>
        <div id="nasobenieS" class="w3-row w3-margin"></div>
    </div>
    <br />
    <br/>

    <input type="button" id="generate" value="Generovať" />
    <div id="container"  class="w3-row ">
        <div id="problems" style="visibility:hidden"
             class="w3-col w3-margin w3-sand w3-padding-16 s12 m5">
            <span id="problem" class="mainText"></span>
            <input id="result" maxlength="2" style="width: 100px" class="mainText" ></input>
        </div>
        <div id="evaluation" class="w3-col w3-margin s12 m5 w3-light-grey">
        </div>
    </div>
    <span id="finalResult"></span>
</body>
